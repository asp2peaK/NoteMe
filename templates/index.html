<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteMe</title>
    <style>
        :root[data-theme="light"] {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
            --primary-color: #4CAF50;
            --secondary-color: #888;
            --input-bg: white;
        }
        
        :root[data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --primary-color: #66bb6a;
            --secondary-color: #666;
            --input-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 500;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .note-form {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        select {
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 13px;
        }

        .note {
            background: var(--card-bg);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            position: relative;
        }

        .note.archived {
            opacity: 0.7;
        }

        .note h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 500;
        }

        .note-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 4px;
        }

        .note-buttons button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .note-buttons button[title="–£–¥–∞–ª–∏—Ç—å"] {
            background: #e57373;
        }

        .note-buttons button[title="–£–¥–∞–ª–∏—Ç—å"]:hover {
            background: #ef5350;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            background: var(--secondary-color);
            color: var(--text-color);
            border-radius: 4px;
            font-size: 11px;
            margin-right: 4px;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .category {
            color: var(--secondary-color);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .markdown-help {
            color: var(--secondary-color);
            font-size: 12px;
            margin-top: 8px;
        }

        .note-content {
            margin: 12px 0;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .note-meta {
            font-size: 11px;
            color: var(--secondary-color);
            margin-top: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .modal-content {
            position: relative;
            background: var(--card-bg);
            margin: 40px auto;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .modal-content input,
        .modal-content textarea {
            margin-bottom: 15px;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            color: var(--secondary-color);
            line-height: 1;
            padding: 0 5px;
        }

        .close:hover {
            color: var(--text-color);
        }

        .import-form {
            display: none;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NoteMe</h1>
        <div class="header-buttons">
            <button onclick="toggleTheme()" id="themeToggle">üåô</button>
            <button onclick="document.getElementById('importInput').click()">üì•</button>
            <a href="/export_notes" style="text-decoration: none;">
                <button>üì§</button>
            </a>
        </div>
    </div>
    
    <div class="note-form">
        <form action="{{ url_for('add_note') }}" method="post">
            <input type="text" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" required>
            <textarea name="content" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown –∏ #—Ç–µ–≥–∏)" required></textarea>
            <input type="text" name="category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" list="categories">
            <datalist id="categories">
                {% for category in categories %}
                <option value="{{ category }}">
                {% endfor %}
            </datalist>
            <div class="markdown-help">
                **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, # –ó–∞–≥–æ–ª–æ–≤–æ–∫, - —Å–ø–∏—Å–æ–∫
            </div>
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <div class="controls">
        <input type="text" class="search-box" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
        <select id="categoryFilter">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if category == current_category %}selected{% endif %}>
                {{ category }}
            </option>
            {% endfor %}
        </select>
        <select id="tagFilter">
            <option value="">–í—Å–µ —Ç–µ–≥–∏</option>
            {% for tag in tags %}
            <option value="{{ tag }}" {% if tag == current_tag %}selected{% endif %}>
                #{{ tag }}
            </option>
            {% endfor %}
        </select>
        <button onclick="toggleSort()" id="sortButton">‚¨á</button>
        <button onclick="toggleArchived()" id="archiveButton" data-archived="{{ 'true' if show_archived else 'false' }}">
            {{ 'üìÅ' if show_archived else 'üìÇ' }}
        </button>
    </div>

    {% for note in notes %}
    <div class="note {% if note.get('archived', False) %}archived{% endif %}">
        <h3>{{ note.title }}</h3>
        {% if note.category and note.category.strip() %}
        <div class="category">{{ note.category }}</div>
        {% endif %}
        {% for tag in note.get('tags', []) %}
        <span class="tag">#{{ tag }}</span>
        {% endfor %}
        <div class="note-content">
            {{ note.content }}
        </div>
        <div class="note-meta">
            {{ note.created_at }}
            {% if note.get('updated_at') %}
            ¬∑ –∏–∑–º–µ–Ω–µ–Ω–æ: {{ note.updated_at }}
            {% endif %}
        </div>
        <div class="note-buttons">
            <button onclick="editNote(this)" 
                    data-id="{{ note.id }}"
                    data-title="{{ note.title|tojson|safe }}"
                    data-content="{{ note.content|tojson|safe }}"
                    data-category="{{ note.category|tojson|safe }}"
                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
            <form action="{{ url_for('toggle_archive', note_id=note.id) }}" method="post" style="display: inline;">
                <button type="submit" title="{{ '–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if note.get('archived', False) else '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}">
                    {{ 'üì§' if note.get('archived', False) else 'üì•' }}
                </button>
            </form>
            <form action="{{ url_for('delete_note', note_id=note.id) }}" method="post" style="display: inline;">
                <button type="submit" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
            </form>
        </div>
    </div>
    {% endfor %}

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="editForm" method="post">
                <input type="text" name="title" id="editTitle" required>
                <textarea name="content" id="editContent" required></textarea>
                <input type="text" name="category" id="editCategory" list="categories">
                <div class="markdown-help">
                    **–∂–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, # –ó–∞–≥–æ–ª–æ–≤–æ–∫, - —Å–ø–∏—Å–æ–∫
                </div>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <input type="file" id="importInput" class="import-form" accept=".json" 
           onchange="this.form.submit()" form="importForm">
    <form id="importForm" action="{{ url_for('import_notes') }}" method="post" 
          enctype="multipart/form-data"></form>

    <script>
        // –¢–µ–º–∞
        function toggleTheme() {
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            themeToggle.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', newTheme);
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editTitle = document.getElementById('editTitle');
        const editContent = document.getElementById('editContent');
        const editCategory = document.getElementById('editCategory');

        function editNote(button) {
            editModal.style.display = 'block';
            editForm.action = `/edit_note/${button.dataset.id}`;
            editTitle.value = JSON.parse(button.dataset.title);
            editContent.value = JSON.parse(button.dataset.content);
            editCategory.value = JSON.parse(button.dataset.category);
        }

        const closeBtn = document.querySelector('.close');
        closeBtn.onclick = function() {
            editModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        let currentSort = 'desc';
        let showArchived = document.getElementById('archiveButton').dataset.archived === 'true';
        
        function toggleSort() {
            currentSort = currentSort === 'desc' ? 'asc' : 'desc';
            const sortButton = document.getElementById('sortButton');
            sortButton.textContent = currentSort === 'desc' ? '‚¨á' : '‚¨Ü';
            updateURL();
        }

        function toggleArchived() {
            showArchived = !showArchived;
            updateURL();
        }

        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const tagFilter = document.getElementById('tagFilter');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(updateURL, 300);
        });

        categoryFilter.addEventListener('change', updateURL);
        tagFilter.addEventListener('change', updateURL);

        function updateURL() {
            const searchQuery = searchInput.value;
            const category = categoryFilter.value;
            const tag = tagFilter.value;
            const newURL = `${window.location.pathname}?search=${encodeURIComponent(searchQuery)}&sort=${currentSort}&category=${encodeURIComponent(category)}&tag=${encodeURIComponent(tag)}&archived=${showArchived}`;
            window.location.href = newURL;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        currentSort = urlParams.get('sort') || 'desc';
        document.getElementById('sortButton').textContent = currentSort === 'desc' ? '‚¨á' : '‚¨Ü';
        searchInput.value = urlParams.get('search') || '';
    </script>
</body>
</html>
